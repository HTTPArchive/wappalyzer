name: Upload technologies to BQ and Cloud Storage

on:
  push:
    branches:
      - main
      - fix-icon-extension
    paths:
      - "src/technologies/*.json"
      - "src/categories.json"
      - "src/groups.json"
      - "src/images/icons/**"
  workflow_dispatch:

jobs:
  test:
    name: Test and upload to GCP
    runs-on: ubuntu-latest
    steps:

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 25


      - name: Install dependencies
        run: yarn install

      - name: Validate
        id: validate
        run: yarn run validate

      - name: Check validation status
        if: ${{ failure() && steps.validate.conclusion == 'failure' }}
        run: |
          echo "Validation failed. Stopping workflow."
          exit 1

      - name: Get Changed Technology Files
        run: |
          git fetch origin main --depth=25
          TECH_FILES_CHANGED=$(git diff --name-only HEAD~25 HEAD -- 'src/technologies/*.json' 'src/categories.json' 'src/groups.json' | wc -l)
          echo $TECH_FILES_CHANGED
          echo "TECH_FILES_CHANGED=${TECH_FILES_CHANGED}" >> $GITHUB_ENV

      - name: Upload technology rules to BigQuery
        if: env.TECH_FILES_CHANGED != ''
        env:
          GCP_PROJECT_ID: 'httparchive'
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: echo $TECH_FILES_CHANGED
        # yarn run tech_upload

      - name: Get Changed Icons
        run: |
          git fetch origin main --depth=25
          CHANGED_ICONS=$(git diff --name-only HEAD~25 HEAD -- 'src/images/icons/*.svg' 'src/images/icons/*.png' | xargs)
          echo $CHANGED_ICONS
          echo "CHANGED_ICONS=${CHANGED_ICONS}" >> $GITHUB_ENV

      - name: Install Image Convertion Package
        if: env.CHANGED_ICONS != ''
        run: sudo apt-get install -y librsvg2-bin

      - name: Convert Only Changed SVGs to PNGs
        if: env.CHANGED_ICONS != ''
        run: |
          for file in $CHANGED_ICONS; do
            if [[ "$file" == *.svg ]]; then
              png_file="${file%.svg}.png"
              echo "Converting $file to $png_file"
              rsvg-convert "$file" -o "$png_file" -w 16 -h 16
            fi
          done

      - name: Authenticate with Google Cloud
        if: env.CHANGED_ICONS != ''
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          echo "$GCP_SA_KEY" > gcp-key.json
          gcloud config set project httparchive
          gcloud auth activate-service-account --key-file=gcp-key.json

      - name: Sync Only New PNGs to Cloud Storage
        if: env.CHANGED_ICONS != ''
        run: |
          TMP_SYNC_DIR=$(mktemp -d)
          for file in $CHANGED_ICONS; do
            if [[ "$file" == *.png || "$file" == *.svg ]]; then
              png_file="${file%.svg}.png"
              cp "icons/$png_file" "$TMP_SYNC_DIR/"
            fi
          done

          gcloud storage rsync "$TMP_SYNC_DIR" gs://httparchive/static/icons_dev/ --exclude="*.svg" --continue-on-error --gzip-in-flight=png --cache-control="public, max-age=31536000, immutable"

